
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Professional Invoice — Asad</title>
  <meta name="theme-color" content="#0b4f6c"/>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%230b4f6c%22/><text x=%2250%22 y=%2258%22 font-size=%2246%22 text-anchor=%22middle%22 fill=%22%23fff%22 font-family=%22Arial%22>₨</text></svg>">
  <!-- JS libs for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5XqGkY1Z2lqsl3fF6m8i3mYqjMYr1kN1x8l1R7q2G1zv1a9t5w6zA2vQ7N6+qZc7hb3z3d9F0d2n1Y0B5g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-/tH3o6Nw7N1m9p6Jk8v1e2Q7qYkPz4yZ1s2s8s3y4t1m9j3Qc2Q7z1kP5H2n9m7J" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    /* Professional theme: teal, charcoal, gold */
    :root{
      --primary:#0b4f6c;
      --accent:#f0a500;
      --muted:#6b7280;
      --bg:#f7fbfc;
      --card:#ffffff;
      --danger:#d64545;
      --success:#2a9d8f;
      --font-sans: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font-sans); background:linear-gradient(180deg,#f7fbfc, #eef7fa);
      color:#0f1724; -webkit-font-smoothing:antialiased;
    }
    .app{
      max-width:1200px; margin:28px auto; padding:24px; display:grid;
      grid-template-columns:380px 1fr; gap:20px;
    }
    .card{background:var(--card); border-radius:10px; box-shadow:0 6px 18px rgba(11,79,108,0.08); padding:18px}
    header{display:flex; align-items:center; gap:12px; margin-bottom:16px}
    header h1{margin:0; font-size:18px; color:var(--primary)}
    .muted{color:var(--muted); font-size:13px}

    /* Left: product manager */
    .products-header{display:flex; justify-content:space-between; align-items:center; gap:8px}
    .search{display:flex; gap:8px; margin:10px 0}
    .search input{flex:1; padding:8px 10px; border:1px solid #e6eef2; border-radius:8px}
    .btn{display:inline-block; padding:8px 12px; border-radius:8px; cursor:pointer; border:none; background:var(--primary); color:#fff; font-weight:600}
    .btn.ghost{background:transparent; color:var(--primary); border:1px solid rgba(11,79,108,0.08)}
    .btn.danger{background:var(--danger)}
    .product-list{max-height:560px; overflow:auto; margin-top:8px}
    .product{display:flex; justify-content:space-between; gap:8px; padding:10px; border-radius:8px; align-items:center; border:1px solid #f1f6f8; margin-bottom:8px}
    .product .meta{display:flex; gap:8px; align-items:center}
    .product strong{display:block}
    .small-muted{font-size:12px; color:var(--muted)}

    /* Right: invoice */
    .invoice-top{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px}
    .invoice-area{padding:20px; border-radius:10px; border:1px solid #eef6f8; background:linear-gradient(180deg,#fff,#fbfeff)}
    .invoice-header{display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:12px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:64px; height:64px; background:var(--primary); color:#fff; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:28px}
    .invoice-id{font-weight:700; color:var(--primary)}
    .field{margin-bottom:8px}
    .items-table{width:100%; border-collapse:collapse; margin-top:8px}
    .items-table th, .items-table td{padding:10px; border-bottom:1px solid #eef6f8; text-align:left}
    .items-table input{width:80px; padding:6px; border-radius:6px; border:1px solid #e6eef2}
    .text-right{text-align:right}
    .totals{margin-top:12px; display:flex; justify-content:flex-end}
    .totals .box{width:320px; padding:12px; border-radius:8px; background:#fff; border:1px solid #eef6f8}
    .totals .row{display:flex; justify-content:space-between; padding:6px 0}
    .actions{display:flex; gap:8px; margin-top:12px; justify-content:flex-end}
    footer{margin-top:10px; font-size:12px; color:var(--muted); text-align:center}

    /* modal */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(3,7,18,0.45)}
    .modal.open{display:flex}
    .modal .modal-card{width:720px; max-width:95%; background:#fff; padding:18px; border-radius:10px}
    .form-row{display:flex; gap:8px; margin-bottom:8px}
    .form-row input{flex:1; padding:8px; border-radius:8px; border:1px solid #eef6f8}

    @media (max-width:960px){
      .app{grid-template-columns:1fr; padding:12px}
      .products-header{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <div>
          <h1>Products</h1>
          <div class="muted">Add, edit or remove products</div>
        </div>
      </header>

      <div class="products-header">
        <div style="flex:1">
          <div class="search">
            <input id="productSearch" placeholder="Search products by name..." />
            <button class="btn ghost" id="newProductBtn">+ New</button>
          </div>
        </div>
      </div>

      <div class="product-list card" id="productList" style="padding:12px; max-height:520px; overflow:auto"></div>
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:space-between">
        <button class="btn ghost" id="resetProducts">Reset sample</button>
        <button class="btn" id="clearStorage">Clear All Data</button>
      </div>
    </div>

    <div class="card">
      <div class="invoice-top">
        <div>
          <h2 style="margin:0; color:var(--primary)">Invoice (PKR)</h2>
          <div class="muted">Professional, full-colour invoice</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center">
          <label class="small-muted">Invoice name:</label>
          <input id="invoiceName" placeholder="e.g., ACME Corporation" style="padding:8px;border-radius:8px;border:1px solid #eef6f8" />
        </div>
      </div>

      <div class="invoice-area" id="invoiceArea">
        <div class="invoice-header">
          <div class="brand">
            <div class="logo">M.Asad</div>
            <div>
              <div style="font-weight:700; font-size:16px" id="brandName">My Company</div>
              <div class="small-muted">Professional Invoice • PKR</div>
            </div>
          </div>
          <div>
            <div class="invoice-id">Invoice — <span id="invoiceNumber">#001</span></div>
            <div class="small-muted" id="dateNow"></div>
          </div>
        </div>

        <table class="items-table" id="itemsTable" aria-live="polite">
          <thead>
            <tr>
              <th style="width:36%">Item</th>
              <th>Rate (PKR)</th>
              <th>Qty</th>
              <th>Discount %</th>
              <th class="text-right">Line total</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>

        <div class="totals">
          <div class="box">
            <div class="row"><div>Subtotal</div><div id="subtotal" class="text-right">₨0.00</div></div>
            <div class="row"><div>Discount (per line)</div><div id="totalDiscount" class="text-right">₨0.00</div></div>
            <div class="row" style="font-weight:700; border-top:1px dashed #eef6f8; padding-top:10px"><div>Total</div><div id="grandTotal" class="text-right">₨0.00</div></div>
          </div>
        </div>

      </div> <!-- invoice-area -->

      <div class="actions">
        <button class="btn ghost" id="clearBillBtn">Clear bill</button>
        <button class="btn" id="downloadPdfBtn">Download PDF</button>
      </div>

      <footer>
        <div>Theme icon + manifest included. Works offline via Service Worker.</div>
      </footer>
    </div>
  </div>

  <!-- Modal: Add / Edit Product -->
  <div class="modal" id="productModal" role="dialog" aria-hidden="true">
    <div class="modal-card">
      <h3 id="modalTitle">New Product</h3>
      <div class="form-row">
        <input id="prodName" placeholder="Product name" />
        <input id="prodRate" type="number" placeholder="Rate (PKR)" />
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px">
        <button class="btn ghost" id="modalCancel">Cancel</button>
        <button class="btn" id="modalSave">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Minimal comments, focusing on 'why' only where needed.
    // State keys
    const LS_PRODUCTS = 'invoice_products_v1';
    const LS_BILL = 'invoice_bill_v1';
    // DOM
    const productListEl = document.getElementById('productList');
    const productSearch = document.getElementById('productSearch');
    const newProductBtn = document.getElementById('newProductBtn');
    const productModal = document.getElementById('productModal');
    const modalTitle = document.getElementById('modalTitle');
    const prodName = document.getElementById('prodName');
    const prodRate = document.getElementById('prodRate');
    const modalCancel = document.getElementById('modalCancel');
    const modalSave = document.getElementById('modalSave');
    const resetProducts = document.getElementById('resetProducts');
    const clearStorageBtn = document.getElementById('clearStorage');

    const itemsBody = document.getElementById('itemsBody');
    const subtotalEl = document.getElementById('subtotal');
    const totalDiscountEl = document.getElementById('totalDiscount');
    const grandTotalEl = document.getElementById('grandTotal');
    const invoiceName = document.getElementById('invoiceName');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const clearBillBtn = document.getElementById('clearBillBtn');
    const dateNow = document.getElementById('dateNow');
    const invoiceNumber = document.getElementById('invoiceNumber');

    // In-memory editing vars
    let products = [];
    let bill = [];
    let editingProductId = null;

    // Utilities
    const uid = () => Math.random().toString(36).slice(2,9);
    const pkr = n => '₨' + Number(n || 0).toLocaleString('en-PK', {minimumFractionDigits:2, maximumFractionDigits:2});

    // Storage helpers
    function loadState(){
      const p = localStorage.getItem(LS_PRODUCTS);
      const b = localStorage.getItem(LS_BILL);
      products = p ? JSON.parse(p) : getSampleProducts();
      bill = b ? JSON.parse(b) : [];
    }
    function saveProducts(){ localStorage.setItem(LS_PRODUCTS, JSON.stringify(products)); }
    function saveBill(){ localStorage.setItem(LS_BILL, JSON.stringify(bill)); }

    // Sample products — quick start
    function getSampleProducts(){
      return [
        {id:uid(), name:"Website Design", rate:25000},
        {id:uid(), name:"Monthly Hosting", rate:3000},
        {id:uid(), name:"Logo Design", rate:8000},
        {id:uid(), name:"Consultation (hour)", rate:1500},
      ];
    }

    // Product UI
    function renderProducts(filter=''){
      productListEl.innerHTML = '';
      const list = products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
      if(!list.length){ productListEl.innerHTML = '<div class="small-muted">No products found.</div>'; return; }
      list.forEach(p=>{
        const div = document.createElement('div'); div.className='product';
        div.innerHTML = `
          <div class="meta">
            <div>
              <strong>${escapeHtml(p.name)}</strong>
              <div class="small-muted">${pkr(p.rate)}</div>
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <button class="btn ghost" data-action="edit" data-id="${p.id}">Edit</button>
            <button class="btn" data-action="add" data-id="${p.id}">Add</button>
          </div>`;
        productListEl.appendChild(div);
      });
    }

    // Escape for safety
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

    // Modal actions
    newProductBtn.addEventListener('click', ()=>{ openProductModal(); });
    modalCancel.addEventListener('click', closeProductModal);
    modalSave.addEventListener('click', ()=>{
      const name = prodName.value.trim();
      const rate = Number(prodRate.value || 0);
      if(!name || rate <= 0){ alert('Please enter name and positive rate'); return; }
      if(editingProductId){
        const idx = products.findIndex(x=>x.id===editingProductId);
        if(idx>=0){ products[idx].name = name; products[idx].rate = rate; saveProducts(); renderProducts(productSearch.value); refreshBillItems(); }
      } else {
        products.unshift({id:uid(), name, rate});
        saveProducts(); renderProducts(productSearch.value);
      }
      closeProductModal();
    });

    function openProductModal(product=null){
      productModal.classList.add('open');
      productModal.setAttribute('aria-hidden','false');
      if(product){
        editingProductId = product.id; modalTitle.textContent='Edit Product'; prodName.value = product.name; prodRate.value = product.rate;
      } else {
        editingProductId = null; modalTitle.textContent='New Product'; prodName.value=''; prodRate.value='';
      }
    }
    function closeProductModal(){ productModal.classList.remove('open'); productModal.setAttribute('aria-hidden','true'); editingProductId=null; }

    // Delegate product list clicks
    productListEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      if(action==='add'){ addProductToBill(id); }
      if(action==='edit'){ const p = products.find(x=>x.id===id); if(p) openProductModal(p); }
    });

    // Reset sample products
    resetProducts.addEventListener('click', ()=>{ if(confirm('Reset to sample products? This will overwrite current product list.')){ products = getSampleProducts(); saveProducts(); renderProducts(''); }});
    clearStorageBtn.addEventListener('click', ()=>{ if(confirm('Clear all saved products and bills?')){ localStorage.removeItem(LS_PRODUCTS); localStorage.removeItem(LS_BILL); loadState(); renderProducts(''); renderBill(); } });

    // Search
    productSearch.addEventListener('input', ()=>renderProducts(productSearch.value));

    // Bill operations
    function addProductToBill(productId){
      const p = products.find(x=>x.id===productId);
      if(!p) return;
      const existing = bill.find(b => b.productId === p.id);
      if(existing){ existing.qty += 1; } else {
        bill.push({productId: p.id, name: p.name, rate: p.rate, qty:1, discountPercent:0});
      }
      saveBill(); renderBill();
    }

    function renderBill(){
      itemsBody.innerHTML = '';
      if(bill.length===0){ itemsBody.innerHTML = '<tr><td colspan="6" class="small-muted">No items added. Click "Add" on a product to start the bill.</td></tr>'; updateTotals(); return; }
      bill.forEach((item, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div style="display:flex; justify-content:space-between; align-items:center">
              <div>
                <strong>${escapeHtml(item.name)}</strong>
                <div class="small-muted">ID: ${item.productId}</div>
              </div>
            </div>
          </td>
          <td>${pkr(item.rate)}</td>
          <td><input type="number" min="0" value="${item.qty}" data-idx="${idx}" data-field="qty" /></td>
          <td><input type="number" min="0" max="100" value="${item.discountPercent}" data-idx="${idx}" data-field="discount" /></td>
          <td class="text-right" id="line-${idx}">${pkr(lineTotal(item))}</td>
          <td style="text-align:right">
            <button class="btn ghost" data-action="edit-product" data-idx="${idx}">Edit</button>
            <button class="btn" data-action="remove" data-idx="${idx}">Remove</button>
          </td>
        `;
        itemsBody.appendChild(tr);
      });
      // wire inputs
      itemsBody.querySelectorAll('input[data-field]').forEach(inp=>{
        inp.addEventListener('change', (e)=>{
          const idx = Number(e.target.dataset.idx);
          const field = e.target.dataset.field;
          const val = Number(e.target.value || 0);
          if(field==='qty'){ bill[idx].qty = val >= 0 ? val : 0; }
          if(field==='discount'){ bill[idx].discountPercent = val >= 0 ? (val>100?100:val) : 0; }
          saveBill(); refreshBillItems();
        });
      });
      // wire buttons
      itemsBody.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const action = btn.dataset.action;
          const idx = Number(btn.dataset.idx);
          if(action==='remove'){ bill.splice(idx,1); saveBill(); renderBill(); }
          if(action==='edit-product'){ // open product modal to edit underlying product if exists
            const prod = products.find(p=>p.id === bill[idx].productId);
            if(prod){ openProductModal(prod); }
            else { alert('Underlying product not found'); }
          }
        });
      });
      updateTotals();
    }

    function lineTotal(item){
      const base = item.rate * item.qty;
      const disc = base * (item.discountPercent/100);
      return Math.max(0, base - disc);
    }

    function refreshBillItems(){
      bill.forEach((it, idx)=> {
        const el = document.getElementById(`line-${idx}`);
        if(el) el.textContent = pkr(lineTotal(it));
      });
      updateTotals();
    }

    function updateTotals(){
      const subtotal = bill.reduce((s, it)=> s + (it.rate * it.qty), 0);
      const totalDiscount = bill.reduce((s, it)=> s + ((it.rate * it.qty) * (it.discountPercent/100)), 0);
      const total = subtotal - totalDiscount;
      subtotalEl.textContent = pkr(subtotal);
      totalDiscountEl.textContent = pkr(totalDiscount);
      grandTotalEl.textContent = pkr(total);
    }

    // clear bill
    clearBillBtn.addEventListener('click', ()=>{ if(confirm('Clear current bill?')){ bill = []; saveBill(); renderBill(); }});

    // pdf download
    downloadPdfBtn.addEventListener('click', async ()=>{
      downloadPdfBtn.disabled = true;
      downloadPdfBtn.textContent = 'Generating...';
      try{
        // prepare invoice view: set invoice name and date
        const name = invoiceName.value.trim();
        document.getElementById('brandName').textContent = name || 'My Company';
        dateNow.textContent = (new Date()).toLocaleString('en-GB', {dateStyle:'medium', timeStyle:'short'});
        // use html2canvas -> jsPDF
        const node = document.getElementById('invoiceArea');
        const canvas = await html2canvas(node, {scale:2, useCORS:true});
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({unit:'pt', format:'a4', compress:true});
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        // Fit image to page keeping aspect
        const imgProps = {width: canvas.width, height: canvas.height};
        const ratio = Math.min(pageWidth / imgProps.width, pageHeight / imgProps.height);
        const w = imgProps.width * ratio;
        const h = imgProps.height * ratio;
        pdf.addImage(imgData, 'PNG', (pageWidth - w)/2, 20, w, h);
        const fileName = (invoiceName.value ? invoiceName.value.replace(/\s+/g,'_') + '_' : '') + 'invoice_' + (new Date()).toISOString().slice(0,19).replaceAll(':','') + '.pdf';
        pdf.save(fileName);
      }catch(err){
        console.error(err);
        alert('Failed to generate PDF: ' + err.message);
      } finally {
        downloadPdfBtn.disabled = false;
        downloadPdfBtn.textContent = 'Download PDF';
      }
    });

    // Initialize app
    function init(){
      loadState();
      renderProducts('');
      renderBill();
      // invoice number + date
      const now = new Date();
      invoiceNumber.textContent = '#' + now.getFullYear().toString().slice(-2) + String(now.getMonth()+1).padStart(2,'0') + now.getDate().toString().padStart(2,'0') + '-' + Math.floor(Math.random()*900+100);
      dateNow.textContent = now.toLocaleDateString();
      // register service worker
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('service-worker.js').catch(()=>{/*silent*/});
      }
    }

    // react to product edit saving (we saved in modalSave)
    // also allow clicking product name to edit underlying product — not required but handy
    document.addEventListener('DOMContentLoaded', init);

    // small helper to refresh bill totals when product rates changed
    // If a product is edited, update any bill items that reference it
    // We'll run a quick observer on storage change + when product modal closes
    window.addEventListener('storage', ()=>{
      loadState();
      renderProducts(productSearch.value);
      renderBill();
    });

    // ensure bill totals stay in sync when products edited then modal closed
    modalCancel.addEventListener('click', ()=>{ loadState(); renderProducts(productSearch.value); renderBill(); });
    modalSave.addEventListener('click', ()=>{ loadState(); renderProducts(productSearch.value); renderBill(); });

    // helper to update bill when product rates changed externally
    function syncProductChanges(){
      const prodMap = Object.fromEntries(products.map(p=>[p.id,p]));
      let changed=false;
      bill.forEach(it=>{
        const p = prodMap[it.productId];
        if(p && p.rate !== it.rate){ it.rate = p.rate; changed=true; }
      });
      if(changed){ saveBill(); renderBill(); }
    }
    // call periodically to sync edits
    setInterval(()=>{ loadState(); syncProductChanges(); }, 2000);

  </script>
</body>
</html>
